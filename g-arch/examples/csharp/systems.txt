using System.Threading.Tasks;

namespace GArch_CSharp_Example
{
    public interface ISystemManagerImpl
    {
        void ControlPlayer(IReadOnlyGameState gameState, GameStateModification gameStateModifier);

        void DrawPlayer(IReadOnlyGameState gameState, GameStateModification gameStateModifier);

        void MovePlayer(IReadOnlyGameState gameState, GameStateModification gameStateModifier);
    }

    public class SystemManager
    {
        private readonly ISystemManagerImpl _impl;
        private readonly GameStateModification controlPlayerModification, movePlayerModification, drawPlayerModification;

        public SystemManager(ISystemManagerImpl impl)
        {
            _impl = impl;
            controlPlayerModification = new GameStateModification();
            movePlayerModification = new GameStateModification();
            drawPlayerModification = new GameStateModification();
        }

        public void Update(IReadOnlyGameState gameState, GameState newGameState)
        {
            Reset();

            _impl.ControlPlayer(gameState, controlPlayerModification);
            _impl.MovePlayer(gameState, movePlayerModification);
            _impl.DrawPlayer(gameState, drawPlayerModification);

            UpdateGameState(gameState, newGameState);
        }

        public async Task UpdateAsync(IReadOnlyGameState gameState, GameState newGameState)
        {
            Reset();

            await Task.WhenAll(
                Task.Run(() => _impl.ControlPlayer(gameState, controlPlayerModification)),
                Task.Run(() => _impl.MovePlayer(gameState, movePlayerModification)),
                Task.Run(() => _impl.DrawPlayer(gameState, drawPlayerModification))
            );

            UpdateGameState(gameState, newGameState);
        }

        private void UpdateGameState(IReadOnlyGameState oldGameState, GameState newGameState)
        {
            newGameState.Copy(oldGameState);
            newGameState.AddModification(controlPlayerModification);
            newGameState.AddModification(movePlayerModification);
            newGameState.AddModification(drawPlayerModification);
        }

        private void Reset()
        {
            controlPlayerModification.Reset();
            movePlayerModification.Reset();
            drawPlayerModification.Reset();
        }
    }
}